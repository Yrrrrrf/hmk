@host = http://localhost:8080
@contentType = application/json

# ==========================================
# 1. GET ALL USERS (Tutorial Slide 29)
# ==========================================
# This checks if the endpoint exists and returns a list.
GET {{host}}/api/users/all
Accept: {{contentType}}

# ignore_unused
> {%
    client.test("Request executed successfully", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });

    client.test("Response is an array", function() {
        client.assert(Array.isArray(response.body), "Body is not an array");
    });
%}

###

# ==========================================
# 2. SAVE NEW USER (Tutorial Slide 31)
# ==========================================
# We create a new user via JSON.
# We verify the response contains the ID generated by the DB.
# We save that ID to a variable to delete it later.
# @name createUser
POST {{host}}/api/users/save
Content-Type: {{contentType}}

{
    "login": "vscode_user",
    "password": "mySecretPassword123",
    "email": "vscode@test.com"
}

> {%
    client.test("User created successfully", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });

    client.test("Response contains ID", function() {
        client.assert(response.body.hasOwnProperty("id"), "Cannot find 'id' in response");
        client.assert(response.body.id !== null, "ID should not be null");
    });

    client.test("Response matches login", function() {
        client.assert(response.body.login === "vscode_user", "Login name mismatch");
    });

    // Save the new ID to a variable for the next request
    client.global.set("newUserId", response.body.id);
%}

###

# ==========================================
# 3. DELETE USER (Tutorial Slide 23)
# ==========================================
# We use the {{newUserId}} captured from the previous step.
DELETE {{host}}/api/users/{{newUserId}}

> {%
    client.test("User deleted successfully", function() {
        // Your controller returns 204 (No Content) usually for delete
        // But currently it returns 204 or 200 depending on implementation
        client.assert(response.status === 204 || response.status === 200, "Response status is not 204 or 200");
    });
%}

###

# ==========================================
# 4. TEST LOGIN (MVC Form Login)
# ==========================================
# This tests the HTML form login used by the game view.
# It mimics a browser sending form data.
POST {{host}}/login
Content-Type: application/x-www-form-urlencoded

login=player1&password=pass1

> {%
    client.test("Login redirects successfully", function() {
        // Spring Security/MVC usually redirects (302) on success
        // Or returns 200 if the redirection is followed automatically
        client.assert(response.status === 200 || response.status === 302, "Login failed");
    });
    
    client.test("Session cookie received", function() {
        // Check if we got a JSESSIONID
        const cookie = response.headers.valuesOf("Set-Cookie")[0]; 
        client.assert(cookie && cookie.includes("JSESSIONID"), "No Session Cookie returned");
    });
%}